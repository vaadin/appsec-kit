/*-
 * Copyright (C) 2023 Vaadin Ltd
 *
 * This program is available under Vaadin Commercial License and Service Terms.
 *
 *
 * See <https://vaadin.com/commercial-license-and-service-terms> for the full license.
 */

package com.vaadin.appsec.v8.service;

import java.util.List;

import ch.qos.logback.classic.spi.ILoggingEvent;
import ch.qos.logback.core.read.ListAppender;
import org.junit.Assert;
import org.junit.Test;

import com.vaadin.appsec.backend.model.osv.response.OpenSourceVulnerability;
import com.vaadin.appsec.backend.service.BillOfMaterialsStore;
import com.vaadin.appsec.backend.service.VulnerabilityStore;

import static org.mockito.Mockito.when;

public class VulnerabilityStoreInitListenerTest extends AbstractAppSecKitTest {

    @Test
    public void testVulnStoreInit_initsProperly_debugMode() {
        ListAppender<ILoggingEvent> logAppender = createListAppender(
                VulnerabilityStoreInitListener.class.getName());

        initBomStoreInitListener(TEST_RESOURCE_BOM_PATH);
        initVulnStoreInitListener();

        Assert.assertEquals("Unexpected count of log messages. ", 1,
                logAppender.list.size());
        Assert.assertEquals(
                "VulnerabilityStoreInitListener initialization failed.",
                "VulnerabilityStoreInitListener initialized.",
                logAppender.list.get(0).getMessage());

        List<OpenSourceVulnerability> vulnerabilities = VulnerabilityStore
                .getInstance().getVulnerabilities();
        Assert.assertNotNull(vulnerabilities);
        Assert.assertEquals("Mismatch in expected vulnerability count.", 3,
                vulnerabilities.size());
    }
}